!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WKPostMessenger=t()}(this,function(){"use strict";var e=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,i){var a={key:e,arg:t,resolve:n,reject:i,next:null};s?s=s.next=a:(r=s=a,o(e,t))})}function o(n,r){try{var s=t[n](r),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){o("next",e)},function(e){o("throw",e)}):i(s.done?"return":"normal",s.value)}catch(e){i("throw",e)}}function i(e,t){switch(e){case"return":r.resolve({value:t,done:!0});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:!1})}r=r.next,r?o(r.key,r.arg):s=null}var r,s;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),t=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},i=function(t){var i=void 0,r=void 0,s=function(e){return e===Object(e)},a=function(e){return"function"==typeof e};if(a(t)){var u=function(t){function i(){var t;e(this,i);for(var n=arguments.length,r=Array(n),s=0;s<n;s++)r[s]=arguments[s];var a=o(this,(t=i.__proto__||Object.getPrototypeOf(i)).call.apply(t,[this].concat(r)));return a._eemitEvents={},a}return n(i,t),i}(t);i=u.prototype,r=u}else{if(!s(t)&&"undefined"!=typeof t)throw new TypeError("Eemit can only be composed with objects or functions");i=t||{},i._eemitEvents={},r=i}return i.on=function(e,t){if(!t||!a(t))throw new TypeError("Callback must be a function");return this._eemitEvents[e]=this._eemitEvents[e]||[],this._eemitEvents[e].push(t),this},i.off=function(e,t){if(t){if(!a(t))throw new TypeError("Callback must be a function");this._eemitEvents[e].splice(this._eemitEvents[e].indexOf(t),1)}else delete this._eemitEvents[e];return this},i.once=function(e,t){return t._eemitOnce=!0,this.on(e,t),this},i.trigger=function(e){for(var t=this,n=arguments.length,o=Array(n>1?n-1:0),i=1;i<n;i++)o[i-1]=arguments[i];var r=this._eemitEvents[e]&&this._eemitEvents[e].slice()||[];return r.forEach(function(n){n._eemitOnce&&t.off(e,n),n.apply(t,o)}),this},r},r="0.0.1",s=3e3,a="__WK_HANDSHAKE__",u="__WK_CALLBACK__",c="application/x-wkpostmessenger-v1+json",h=function(){var e=0,t=void 0,n=void 0;return{next:function(){return n=t,t=Date.now(),n===t?e+=1:e=0,{value:""+e+t}}}},f=function(){function n(){var t=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=o.handleMessage,a=o.scriptMessageHandler,u=void 0===a?"wkPostMessage":a,c=o.handlerGlobal,f=void 0===c?"wkPostMessengerHandleMessage":c,l=o.callbackGlobal,d=void 0===l?"wkPostMessengerCallback":l,v=o.handshakeTimeout,p=void 0===v?s:v,_=o.messageTimeout,y=void 0===_?s:_,m=o.idGenerator,g=void 0===m?h():m,w=o.autoHandshake,b=void 0===w||w;e(this,n),this._connecting=!1,this._connected=!1,this._emitter=i(),this._hm=f,this._cb=d,this._handshakeTimeout=p,this._messageTimeout=y,this._idGen=g,this.handleMessage=r;try{this.parent=window.webkit.messageHandlers[u]}catch(e){throw new Error("Can't add message handler "+u)}window[f]=function(e,n,o){var i=t._handleMessage(n,o);i&&"function"==typeof i.then?i.then(function(n){return t._sendMessageCallback(e,n)}):t._sendMessageCallback(e,i)},window[d]=function(e,n){t._emitter.trigger(e,n)},b&&this.sendHandshake()}return t(n,[{key:"_handleMessage",value:function(e,t){return"function"==typeof this.handleMessage?this.handleMessage(e,t):null}},{key:"_sendMessage",value:function(e,t,n){var o=this;return new Promise(function(i,r){var s=""+o._idGen.next().value,a={type:c,callback:o._cb,id:s,action:e,data:t},u=void 0,h=function(e){clearTimeout(u),i(e)};n>0&&(u=setTimeout(function(){o._emitter.off(s,h),r("[WKPostMessenger] message acknowledgment timeout")},n)),o._emitter.on(s,h),o.parent.postMessage(a)})}},{key:"_sendMessageCallback",value:function(e,t){var n={type:c,callback:"",action:u,id:e,data:t};this.parent.postMessage(n)}},{key:"sendHandshake",value:function(){var e=this;if(this._connected)throw new Error("[WKPostMessenger] sendHandshake was already completed!!");return this._connecting||(this._connecting=!0,this._whenReady=this._sendMessage(a,this._hm,this._handshakeTimeout).then(function(){e._connected=!0}).catch(function(){return e._connecting=!1,Promise.reject("[WKPostMessenger] handshake acknowledgment timeout")})),this._whenReady}},{key:"sendMessage",value:function(e,t){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._messageTimeout;return this._whenReady||this.sendHandshake(),this._whenReady.then(function(){return n._sendMessage(e,t,o)})}}]),n}();return f.VERSION=r,f});
