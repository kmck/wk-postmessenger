!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WKPostMessenger=t()}(this,function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},s=function(t){var s=void 0,o=void 0,r=function(e){return e===Object(e)},a=function(e){return"function"==typeof e};if(a(t)){var c=function(t){function s(){var t;e(this,s);for(var n=arguments.length,o=Array(n),r=0;r<n;r++)o[r]=arguments[r];var a=i(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(o)));return a._eemitEvents={},a}return n(s,t),s}(t);s=c.prototype,o=c}else{if(!r(t)&&"undefined"!=typeof t)throw new TypeError("Eemit can only be composed with objects or functions");s=t||{},s._eemitEvents={},o=s}return s.on=function(e,t){if(!t||!a(t))throw new TypeError("Callback must be a function");return this._eemitEvents[e]=this._eemitEvents[e]||[],this._eemitEvents[e].push(t),this},s.off=function(e,t){if(t){if(!a(t))throw new TypeError("Callback must be a function");this._eemitEvents[e].splice(this._eemitEvents[e].indexOf(t),1)}else delete this._eemitEvents[e];return this},s.once=function(e,t){return t._eemitOnce=!0,this.on(e,t),this},s.trigger=function(e){for(var t=this,n=arguments.length,i=Array(n>1?n-1:0),s=1;s<n;s++)i[s-1]=arguments[s];var o=this._eemitEvents[e]&&this._eemitEvents[e].slice()||[];return o.forEach(function(n){n._eemitOnce&&t.off(e,n),n.apply(t,i)}),this},o},o="0.0.2",r=3e3,a="__WK_HANDSHAKE__",c="__WK_CALLBACK__",u="application/x-wkpostmessenger-v1+json",h=function(){var e=0,t=void 0,n=void 0;return{next:function(){return n=t,t=Date.now(),n===t?e+=1:e=0,{value:""+e+t}}}},f=function(){function n(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=i.handleMessage,a=i.scriptMessageHandler,c=void 0===a?"wkPostMessage":a,u=i.handlerGlobal,f=void 0===u?"wkPostMessengerHandleMessage":u,d=i.callbackGlobal,l=void 0===d?"wkPostMessengerCallback":d,_=i.handshakeTimeout,p=void 0===_?r:_,v=i.messageTimeout,m=void 0===v?r:v,g=i.idGenerator,y=void 0===g?h():g,w=i.autoHandshake,b=void 0===w||w;e(this,n),this._connecting=!1,this._connected=!1,this._emitter=s(),this._hm=f,this._cb=l,this._handshakeTimeout=p,this._messageTimeout=m,this._idGen=y,this.handleMessage=o;try{this.parent=window.webkit.messageHandlers[c]}catch(e){throw new Error("Can't add message handler "+c)}window[f]=function(e,n,i){var s=t._handleMessage(n,i);s&&"function"==typeof s.then?s.then(function(n){return t._sendMessageCallback(e,n)}):t._sendMessageCallback(e,s)},window[l]=function(e,n){t._emitter.trigger(e,n)},b&&this.sendHandshake()}return t(n,[{key:"_handleMessage",value:function(e,t){return"function"==typeof this.handleMessage?this.handleMessage(e,t):null}},{key:"_sendMessage",value:function(e,t,n){var i=this;return new Promise(function(s,o){var r=""+i._idGen.next().value,a={type:u,callback:i._cb,id:r,action:e,data:t},c=void 0,h=function(e){clearTimeout(c),s(e)};n>0&&(c=setTimeout(function(){i._emitter.off(r,h),o("[WKPostMessenger] message acknowledgment timeout")},n)),i._emitter.on(r,h),i.parent.postMessage(a)})}},{key:"_sendMessageCallback",value:function(e,t){var n={type:u,callback:"",action:c,id:e,data:t};this.parent.postMessage(n)}},{key:"sendHandshake",value:function(){var e=this;if(this._connected)throw new Error("[WKPostMessenger] sendHandshake was already completed!!");return this._connecting||(this._connecting=!0,this._whenReady=this._sendMessage(a,this._hm,this._handshakeTimeout).then(function(){e._connected=!0}).catch(function(){return e._connecting=!1,Promise.reject("[WKPostMessenger] handshake acknowledgment timeout")})),this._whenReady}},{key:"sendMessage",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._messageTimeout;return this._whenReady||this.sendHandshake(),this._whenReady.then(function(){return n._sendMessage(e,t,i)})}}]),n}();return f.VERSION=o,f});
